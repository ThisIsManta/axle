<html>
	<head>
		<title>Axle</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Roboto+Mono:200,400" rel="stylesheet">
		<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />
		<style>
			body {
				position: fixed;
				width: 100%;
				height: 100%;
				background: black;
				margin: 0;
				color: white;
				font-family: 'Roboto Mono', monospace;
				font-weight: 400;
				line-height: 1;
				user-select: none;
				transition: all 0.3s ease-out
			}

			body.time-out {
				background: red;
			}

			.timer {
				height: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.landscape .timer.top {
				display: none;
			}

			.landscape .timer.btm {
				height: 100%;
			}

			.clock {
				width: 80px;
				height: 100%;
				position: fixed;
				background: red;
				box-shadow: 0px 0px 10px 10px red;
				top: 0;
				left: -100px;
			}

			.clock.start {
				animation: slide 1s linear infinite;
			}

			@keyframes slide {
				from {
					transform: translateX(-80px);
				}

				to {
					transform: translateX(calc(100vw + 100px));
				}
			}
		</style>
	</head>
	<body>
		<div class="timer top" style="background: linear-gradient(#00000020, transparent, transparent, transparent, transparent); transform: rotate(180deg);"></div>
		<div class="timer btm"></div>
		<div class="clock"></div>
		<script>
			const tickSound = new Audio('./tick.wav')
			const beepSound = new Audio('./beep.wav')
			const deadSound = new Audio('./dead.wav')

			const options = Object.fromEntries(window.location.search.substring(1).split('&').filter(text => text.length > 0).map(text => text.split('=')))

			const count = Math.floor(parseInt(options.time))
			if (isNaN(count) || count <= 0) {
				options.time = '15'
				window.location.search = Object.entries(options).map(([key, value]) => key + '=' + value).join('&')
			}

			const digit = (Math.floor(count / 60) || '').toString().length + (count >= 60 ? 2 : count.toString().length)
			let value = count
			let timer = null
			const clock = $('.clock')

			function paint() {
				const m = Math.floor(value / 60)
				const s = value % 60

				$('.timer').html(count >= 60 ? (m + '' + `<span style="font-weight: 200;">${String(s).padStart(2, '0')}</span>`) : s)

				if (value === 0) {
					$('body').addClass('time-out')
				} else {
					$('body').removeClass('time-out')
				}
			}
			paint()

			function clearAnimation() {
				clock.removeClass('start')
				void clock[0].offsetWidth // See https://css-tricks.com/restart-css-animation/#update-another-javascript-method-to-restart-a-css-animation
			}

			function resize() {
				if (window.innerWidth > window.innerHeight) {
					$('body').addClass('landscape')
				} else {
					$('body').removeClass('landscape')
				}

				const e = $('.timer.btm')[0]
				const d = Math.min(e.clientWidth, e.clientHeight)
				const f = Math.min(d, d / digit * 1.5)
				$('body')[0].style.fontSize = f + 'px'
			}
			resize()

			function start() {
				clearInterval(timer)
				pushSound()

				document.documentElement.requestFullscreen()

				value = count
				paint()
				clearAnimation()
				clock.addClass('start')

				timer = setInterval(() => {
					value -= 1
					paint()

					if (value === 0) {
						deadSound.play()
						clearInterval(timer)
						timer = null
						clearAnimation()

					} else if (value < 5) {
						beepSound.play()

					} else if (value <= 15) {
						if (value % 2 === 0) {
							tickSound.play()
						}

					} else if (value % 5 === 0) {
						tickSound.play()
					}
				}, 1000)
			}

			function reset() {
				clearInterval(timer)
				timer = null

				document.exitFullscreen()

				value = count
				paint()
				clearAnimation()
			}

			$(window).on('resize', resize)

			$(window).on('click', start)

			$(window).on('dblclick', reset)

			$(window).on('keyup', e => {
				if (e.key === ' ') {
					if (timer === null) {
						start()
					} else {
						reset()
					}
				}
			})

			$(window).on('contextmenu', e => {
				e.preventDefault()

				// TODO: show time setter input
			})

			const soundList = {
				'': new Audio('./button-29.wav'),
				car: new Audio('./car-locked-honk-01.wav'),
				gun: new Audio('./gun-gunshot-01.wav'),
				fun: [
					new Audio('./fart-01.wav'),
					new Audio('./fart-03.wav'),
					new Audio('./fart-06.wav'),
					new Audio('./burp-01.wav'),
					new Audio('./man-scream-01.wav'),
					new Audio('./woman-scream-02.wav'),
				]
			}

			function pushSound() {
				const sound = soundList[options.sound || '']
				if (Array.isArray(sound)) {
					sound[Math.ceil(Math.random() * sound.length) - 1].play()
				} else {
					sound.play()
				}
			}
		</script>
	</body>
</html>